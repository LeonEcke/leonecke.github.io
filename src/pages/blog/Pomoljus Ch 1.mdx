---
title: Pomoljus Ch.1
description: "Chapter one in the project log for the Pomoljus project. This log will dive into the solidification of the Pomoljus into the physical realm and talk about the first out of hopefully many failures and what was learnt from it."
pubDate: July 3, 2023
---

Chapter one in the project log for the Pomoljus project. This log will dive into the solidification of the Pomoljus into the physical realm and talk about the first out of hopefully many failures and what I learnt from it. 

---

## The Physical Realm

As the Pomoljus is a physical object, it's also constrained by physical laws. For electricity to flow from the battery to the LEDs, there needs to be some sort of connection between them made from some conductive material.
The standard for this nowdays happens to be copper <sup>*(or gold if you're fancy)*</sup> stuck to a glassfiber sheet. This is of course a printed circuit board, or PCB. But you cant just connect a power source to a light, as the amount of power that flows through the circuit is directly proportional to the resistance in said circuit.
Upsettingly for us in this purpose, the copper traces on the PCB, and most of our components are quite low resistance, which would give us a current so high that the components would go poof.
Thankfully for us in this purpose, the solution is simple. Just add resistance. For that matter, we have a similar issue with unwanted noise in our various copper traces. So we just filter those out. But to do that, we suddenly need more components.
Our simple corcuit now turned a touch more complex. PCBs are also usually quite ridgid unless you pay extra.
So to make sure we fit the design from the previous chapter [citation], we will actually need two PCBs. One for the lights and two buttons, then one for the rest of it. At least that's the current idea.

## The Lightbar

Five SK6812 RGB LEDs and two buttons of some kind that need to pivot on a central axis. Those are the only two requirements of this board. But if it was this simple.
First things first, we need to connect this PCB with the other PCB. This can be solved in many ways, like having some naked copper pads to solder a couple wires to, or perhaps you add some edge connectors and solder the PCBs together directly.
Both these are valid, but come with their own challenges and limitations. I instead chose a different set of challenges and decided to use a standardized connector.

But which connector? Well, how many wires do we need? We need two wires for each buttons input data, then another for sending data to the SK6812s. Then we also need to power the components, which means we want a 5V and GND wire too. So 5 wires in total. Some searching lead to a JST connector[citation]. If you've seen one of the later Raspberry Pi Pico dev boards, then you will recognice it as the beige connector at the opposite end from the USB port.

Okay, but hold on. Since the 639 page long datasheet for the RP2040 has been a steady companion on all of our nightstands for the past few weeks, we obviously know that the RP2040 can only put out 3.3V. But the SK6812s require a 5V data input? What does that even mean?

---

### \<Tangent: Logic levels and voltages>

Data in the electrical world is represented in many ways. But in the core of it all are the bits. The smallest possible pieces of information. Ones and zeroes. Bits themselves have no intrinsic meaning, and is completely up to the reader.
The buttons for example will "give" a one when pressed in, and a zero when not. But the SK6912s bits will be more structured, taking the shape of 16 bit long binary values in a certain order.

But what are bits? Well that depends on where you want the bits to be. If you're a mainframe computer in the 60s, the bits are probably holes in a sheet of paper. But we're a Pomoljus. For us, the bits are electricity! 
More specifically, they're differences in voltages.

But what are voltages? Okay, lets maybe not go that far. But what voltages is a valid question. You can't stuff 220V into a computer and call it a bit. Things and stuff expect certain voltages, both to work and to decypher them into bits. 
And just to be funny, the voltage to power a device and the voltage it wants as digital logic are usually different. How fun!
The SK6812 LEDs for example require 5V both to power them, and for their data inputs. But the RP2040 that will run the show is powered by 5V, but it's data inputs and outputs are required to be in 3.3V. Which sadly for us is lower than 5V.

Well what if we try and stick it to *the man* and push 3.3V into the 5V logic input of the SK6812 then what? Other than being a real rebel... Nothing really. 3.3 is roughly halfway between logical levels for the SK6812 of zero and five.
That means that the rebellious attempts at bits go straight into **undefined limbo**. 0V will probably still be a zero, but who knows what 3.3V will mean. All in all it's pretty harmless.

That can't be said for if you send 5V into something expecting 3.3V. At the best, you get some undefined behaviour; at worst, you get a puff of magic smoke. Since the device isn't expecting anything above 3.3V, making it able to handle it would just be a waste of resources.

Now that should be enough redundant text about things that most people already know either explicitly or intuativly to return us to where we left off.

 *\</Tangent>*

 ---

Where were we? Right, two different logic levels. Thankfully for us, there's ways to solve this quite easily with the use of a transistor. Think of a transistor as an electrically controlled switch. It takes a current or voltage to controll the internal resistance between two points. That allows a lower voltage source to control a highter voltage source.
Exactly what we need to step up the data from 3.3V to 5V. So let's add a transistor to the shopping list. But... Which transistor? PNP, or NPN, or MOSFET, or J-FET, or... Don't worry about it. This isn't a new problem that needs solving, and smarter people have solved it before. Oh, and we also need another resistor.

Okay and now the buttons. How will they work? Do you press one and they connect 5V to the button input? No, that would just require the other end to have a resistor.
And even then, the RP2040 isn't rated for 5V inputs. So we need to step it down. That we do through the use of a basic electrical principle called voltage division. So we need two more resistors per button to utilize this.

Now for the power supply. Basically all wires act like antennas, which means they pick up whatever signals they can. This is usually just noise and not something we want. So we have to filter it out. This too is an easy fix, though the decoupuling capacitors we are about to add. Capacitors work like tiny batteries <sup>*(Unless you ask my uni teacher, in which case they're closer to rubber bands)*</sup>. The main point is that they resist changes in voltages. How quickly is dependant on their size. Now if we see the noise we have as changes from the standard 5V, then we can also see how adding a component that resists those changes could help us! That's at least the basic idea behind the decoupling transistors that we will add. One for each LED and one for the connector. 

Bam, the shopping list is basically done. To handle the 3 components we wanted, we ended up needing an additional [Sätt in mängd!]! This is ofcourse not the only way to do something, and I'm sure I've made a bakers dozen mistakes. But that's part of the process! Now all we need to do is source every single component. This is not *hard* but it is time consuming, and at times a bit frustrating. The companies that target hobbyists seems to like their 20%-70% conveinence markups. But with some time and effort you can do it. [Links to prefered sites?]Links to prefered sites? The important part here is knowing what fottprint your components will have. The sizes of your passives <sup>*(Resistors, Capacirots, and more)*</sup> are pretty solidly standardized. The transistor is also quite standard. The SK6812s are on the other hand a bit of a bigger question and might require custom made footprints in your PCB CAD software. Since I decided to surface mount my hole mounted buttons, I'll need to do this step anyway. 

Now we can work on the layout and design! 

## Almost there

The first step to making a PCB is to decide on a more abstract scale how things are supposed to connect together. A so called "electrical diagram". It serves the purpose of planning out the internal connections of all the components, but without being restricted by such annoyances as "manufacturability" or "physics". 

<img src="/images/Ch1/ElectricalDiagram.png" width="500px"/>

As you can see, it's just symbols representing components and their respective connections layed out for maximum readability. Connections are made using simple lines that worry not about voltages or amperages. Even teleportation is allowed via the use of labels. The entire purpose is to just give a really clear view of what will be a very not clear view once you start laying it out on a PCB. This is also used by the CAD software to give hints of where things are to be connected <sup>*(Called rats nests)*</sup>. Usually this step isn't too bad, since most PCB CAD software has a good library of all your standard components, and you probably have a pretty good idea of your electrical layout when you get to this step.

A really important part to this though, is verification. Giving the diagram a thorough inspection, running some electrical rules checker tool, and getting it peer reviewed are all essentials. You're gonna wanna take a break of a day or so then inspect it again. Make sure you actually the symbols are correct too. Confirm it with the datasheet! Then get it peer reviewed again. This is by far the cheapest point to find mistakes. Both in time and money. An error caught here can be fixed in minutes. An error caught while routing PCB traces can cost you hours. Even if theres no material cost yet, time is still money. If you're unlucky enough to order a PCB with an error unnoticed then you will spend both hours trying to locate the fault, hours correcting it, and hours correcting the PCB layout. Most likely you've also spent money on the faulty board, and possibly on replacement components.

## Finally a PCB

<img src="/images/Ch1/ComponentLayout.png" width="200px" align="left"/>

Now that we have this all drawn out and peer reviewed, the layout and tracing can begin. I had a specific shape in mind for the lightbar PCB, so I had to work within those restraints. I also knew I wanted all my 5 LEDs spaced evenly across the board, my connector poking out by the bulge in the outline, and one button on each half opposite of the LEDs. I also needed the decoupling capacitors close to the 5V pad for each led, and the logic stepdown resistors close to the buttons. The rest of the components were placed wherever there was room. 

<img src="/images/Ch1/Rats.png" width="180px" align="right"/>

The next step is to connect all the pads with traces. This is probably the most time consuming stage for a project of this size. But thankfully we have the aforementioned rats nest guides. The thin blue lines show you where the closest pad of the same "net", or type, is. Once they're all gone, you're probably done.

There's a reason why electronics engineering is a profession. You can fill a years worth of lectures to learn the ins and outs of traces. How crosstalk, impedance matching, inductive signals, and whatever else affects your signal integrity and currents in your circuit. I know a very little of all this, yet I managed to get lights glowing in the end! A big reason for this is that the SK6812s only need data at 800 KHz. Which might seem like a lot, but the RP2040 runs at 133 MHz. A cool 166 times faster, and the standard desktop PC processor is up over the GHzs. So for this application at our relatively low clockspeeds, no major worry needs to be put in the trace design. The one thing is to keep your power traces <sup>*(5V+ & GND)*</sup> as thick as you can. 

<img src="/images/Ch1/PcbR1.png" sub="the"/>

Then it was just to order the board. Theres a few options out there for small batch prototyping production houses. One well known chinese one that I've used before with pretty good results. Though you also have Aisler in Germany and OshPark in the USA that both have comparable services. Aisler the most costly out of the three, but not anything that will break bank. OshPark is really cheap, but takes a long time to ship from the USA to Europe, and then its import tax ontop of it. For this board I went with Aisler and was really happy!

## My error(s)

This might seem obvious, but it took me about 10 hours to figure this out. It also wasnt my only mistake. I also managed to get tripped up by the SK6812Minis unusual orientation indicator. A mark of some sort usually placed by pin 1 of the chip to allow for proper orientation of an otherwise symmetrical component. The standard SK6812s have this indication by pin 1, but the Minis don't. They place it by pin 3. Which means that you'll end up mounting the LEDs backwards unless you remember this. I did not remember this. 
To this error I gave 3 hours of debugging before it was found. So I desoldered them all, and used my last 5 LEDs to redo it. It still didn't work of course. So I started probing it with an oscilloscope. My signal after the transistor that was supposed to amplify my signal to 5v actually lowered it. My eyes were turned towards the transistor then, since thats where the error seemingly originated from. MOSFETs are quite sensitive to ESD [citation] damage, so I feared I'd damaged it. Therefore I replaced it with a spare. Still no dice.

<img src="/images/Ch1/ProSolder.png" width="300px" align="right"/>

It was at this point that I started questioning my electrical diagram.
I managed to convince myself that I had misremembered how a MOSFET worked and therefore connected it all wrong! I also managed to convince myself that I knew how to properly connect it. So I got yet another transistor, and some really tiny copper thread, and soldered the most finnicky connections I've ever made. Yet this impressive demonstration of patience yelded nothing but strained eyes.

<img src="/images/Ch1/RainbowWire.png" width="300px" align="left"/>

This is around where I noticed a severe lack of voltage across the 5V to GND of my connector. I poked around the connector and wire with the continuity tester of a multimeter and couldn't find out why. So I did the easy thing. I removed it and soldered some wires straight to the connector pads, then superglued them in place. *(It actually turned out really nice, and I'm considering using the colour scheme as the final product.)*

**Yet it still did not work!**

<img src="/images/Ch1/AlienTransistor.png" width="200px" align="right"/>

At this point I was tired and desperate. I had access to some hole mounded MOSFETs, and I knew how they were supposed to work. So I connected them up with a breadboard and conformed that it actually worked. Then I took that confirmed working hole mounting transistor and bent the legs of it and soldered *that* to the PCB.

Yet this frankensteins monster of a PCB did not make the LEDs glow. At this point a friend asked me if I had checked the datasheet. "Of course I have." I said. "But I guess I'll do it again" I thought. The frustration and relief fought as I saw my error. 

<img src="/images/Ch1/MyError.png" width="300px" align="left"/>

***The*** error.

In the haste of wanting to get my hands on a board so that I can start prototyping the software, I missed that KiCad had a footprint for the SK6812Minis. That's why I tried to make my own and in doing so I mixed up the pads for some unexplainable reason. I even managed to mix them up in such a way that I couldnt just rotate the LEDs and hope for the best.

But I had found it. After a few days, I opened my project back up and replaced the faulty symbols in my electrical schematic with correct ones <sup>*(Double checked this time)*</sup> and deleted my PCB layout. Do again, do right.

## Revision 2

Though it sucked that I needed to do a full revising of the board already, I also took this opportunity to fix some general things that had been bothering me with the first rev. Firstly I fixed the obvious things, mainly the faulty symbol, but also an electrical short that required you to break off one of the legs from the buttons.

Since I needed to reroute the traces for all the LEDs, I actually just remade the entire board. That allowed me to change my dimensions also. The board used to be `9.25 mm` by `57.25 mm`, which wasnt optimal. So I instead made it `10.0 mm` by `60.0 mm`. A slight increase in size, but the round centimeters would make my life a lot easier in the future.

<img src="/images/Ch1/Silkscreen.png" width="100px" align="right"/>

I also added a print so that I dont need to look up the schematic every time I want to connect the board to something while debugging. This has actually turned out to be a huge quality of life improvement.

But this is the board as it is today. Other than me goofing up and mounting the SK6812Minis backwards ***again***, I really havent found any critical errors in the PCB design. I had to scale a resistor as it was limiting current too much, and I should add some pull-down resistors to the controlling pin of my MOSFET. But these can survive on the board for now.

<img src="/images/Ch1/Lights.png" width="300px" align="right"/>

Getting the LEDs to blink took a while, as the oversized resistor was hard to find, but after that I am glad to show you a working lightbar! Here it's controlled by a Raspberry Pi Pico development board. But more on that in the next blogpost! I've already put a few hours on it, so hopefully that means it wont die on me anytime soon.

---

## References